<script>
  const status = document.getElementById('status');
  const pathParts = window.location.pathname.split('/');
  const desktopId = pathParts[2] || null;
  const socket = io();

  socket.on('connect', () => {
    status.textContent = 'Connected';
    socket.emit('register', desktopId);
  });

  // Throttle utility
  function throttle(fn, limit) {
    let lastCall = 0;
    return function (...args) {
      const now = Date.now();
      if (now - lastCall >= limit) {
        lastCall = now;
        fn(...args);
      }
    };
  }

  // Emit sliderMove
  const throttledEmit = throttle((x) => {
    socket.emit("sliderMove", { x });
  }, 50); // 20 FPS

  function getOrientation() {
    const orientation = screen.orientation || screen.mozOrientation || screen.msOrientation;
    if (!orientation) return 'portrait'; // Fallback
    return orientation.type.includes('landscape') ? 'landscape' : 'portrait';
  }

  window.addEventListener("deviceorientation", (event) => {
    let tilt;
    let orientation = getOrientation();

    if (orientation === "landscape") {
      tilt = event.beta; // left/right in landscape
      if (typeof tilt === "number") {
        tilt = Math.max(-30, Math.min(30, tilt));
        const x = (tilt + 30) / 60;
        throttledEmit(x);
      }
    } else {
      tilt = event.gamma; // left/right in portrait
      if (typeof tilt === "number") {
        tilt = Math.max(-30, Math.min(30, tilt));
        const x = (tilt + 30) / 60;
        throttledEmit(x);
      }
    }
  });
</script>
